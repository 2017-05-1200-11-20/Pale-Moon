From 4803004fa7fe99283dbb4f153758da77c123abd1 Mon Sep 17 00:00:00 2001
From: "Matt A. Tobin" <email@mattatobin.com>
Date: Wed, 11 Jun 2014 19:19:26 -0400
Subject: [PATCH] Changes to the build config and installer to accommodate
 Windows XP x64 Edition (and Server2k3)

---
 browser/installer/windows/nsis/defines.nsi.in     | 2 +-
 config/config.mk                                  | 4 ++--
 configure.in                                      | 2 +-
 js/src/config/config.mk                           | 4 ++--
 js/src/configure.in                               | 2 +-
 nsprpub/configure                                 | 2 +-
 nsprpub/configure.in                              | 2 +-
 security/nss/coreconf/WIN32.mk                    | 2 +-
 toolkit/mozapps/installer/windows/nsis/common.nsh | 2 +-
 9 files changed, 11 insertions(+), 11 deletions(-)

diff --git a/browser/installer/windows/nsis/defines.nsi.in b/browser/installer/windows/nsis/defines.nsi.in
index 7d873ad..cf11a9a 100644
--- a/browser/installer/windows/nsis/defines.nsi.in
+++ b/browser/installer/windows/nsis/defines.nsi.in
@@ -57,7 +57,7 @@
 #ifdef HAVE_64BIT_OS
 !define HAVE_64BIT_OS
 !define ARCH "x64"
-!define MinSupportedVer "Microsoft Windows Vista x64"
+!define MinSupportedVer "Microsoft Windows XP x64"
 #else
 !define ARCH "x86"
 !define MinSupportedVer "Microsoft Windows XP SP3"
diff --git a/config/config.mk b/config/config.mk
index d92ec8d..f4d17cc 100644
--- a/config/config.mk
+++ b/config/config.mk
@@ -581,7 +581,7 @@ ifeq ($(OS_ARCH),WINNT)
 ifdef GNU_CC
 WIN32_EXE_LDFLAGS	+= -mconsole
 else
-WIN32_EXE_LDFLAGS	+= -SUBSYSTEM:CONSOLE,5.01
+WIN32_EXE_LDFLAGS	+= -SUBSYSTEM:CONSOLE,5.02
 endif
 endif
 else # MOZ_WINCONSOLE
@@ -592,7 +592,7 @@ ifeq ($(OS_ARCH),WINNT)
 ifdef GNU_CC
 WIN32_EXE_LDFLAGS	+= -mwindows
 else
-WIN32_EXE_LDFLAGS	+= -SUBSYSTEM:WINDOWS,5.01
+WIN32_EXE_LDFLAGS	+= -SUBSYSTEM:WINDOWS,5.02
 endif
 endif
 endif
diff --git a/configure.in b/configure.in
index 23f94bf..77b3cd8 100644
--- a/configure.in
+++ b/configure.in
@@ -2118,7 +2118,7 @@ ia64*-hpux*)
         MKCSHLIB='$(LD) -NOLOGO -DLL -OUT:$@ -PDB:$(LINK_PDBFILE) $(DSO_LDOPTS)'
         MKSHLIB_FORCE_ALL=
         MKSHLIB_UNFORCE_ALL=
-        DSO_LDOPTS=-SUBSYSTEM:WINDOWS,5.01
+        DSO_LDOPTS=-SUBSYSTEM:WINDOWS,5.02
         _USE_CPP_INCLUDE_FLAG=1
         _DEFINES_CFLAGS='-FI $(DEPTH)/dist/include/mozilla-config.h -DMOZILLA_CLIENT'
         _DEFINES_CXXFLAGS='-FI $(DEPTH)/dist/include/mozilla-config.h -DMOZILLA_CLIENT'
diff --git a/js/src/config/config.mk b/js/src/config/config.mk
index d92ec8d..f4d17cc 100644
--- a/js/src/config/config.mk
+++ b/js/src/config/config.mk
@@ -581,7 +581,7 @@ ifeq ($(OS_ARCH),WINNT)
 ifdef GNU_CC
 WIN32_EXE_LDFLAGS	+= -mconsole
 else
-WIN32_EXE_LDFLAGS	+= -SUBSYSTEM:CONSOLE,5.01
+WIN32_EXE_LDFLAGS	+= -SUBSYSTEM:CONSOLE,5.02
 endif
 endif
 else # MOZ_WINCONSOLE
@@ -592,7 +592,7 @@ ifeq ($(OS_ARCH),WINNT)
 ifdef GNU_CC
 WIN32_EXE_LDFLAGS	+= -mwindows
 else
-WIN32_EXE_LDFLAGS	+= -SUBSYSTEM:WINDOWS,5.01
+WIN32_EXE_LDFLAGS	+= -SUBSYSTEM:WINDOWS,5.02
 endif
 endif
 endif
diff --git a/js/src/configure.in b/js/src/configure.in
index 7e778fa..969dfae 100644
--- a/js/src/configure.in
+++ b/js/src/configure.in
@@ -1688,7 +1688,7 @@ ia64*-hpux*)
         MKCSHLIB='$(LD) -NOLOGO -DLL -OUT:$@ -PDB:$(LINK_PDBFILE) $(DSO_LDOPTS)'
         MKSHLIB_FORCE_ALL=
         MKSHLIB_UNFORCE_ALL=
-        DSO_LDOPTS=-SUBSYSTEM:WINDOWS,5.01
+        DSO_LDOPTS=-SUBSYSTEM:WINDOWS,5.02
         _USE_CPP_INCLUDE_FLAG=1
         _DEFINES_CFLAGS='-FI $(DEPTH)/js-confdefs.h -DMOZILLA_CLIENT'
         _DEFINES_CXXFLAGS='-FI $(DEPTH)/js-confdefs.h -DMOZILLA_CLIENT'
diff --git a/nsprpub/configure b/nsprpub/configure
index 484a15a..69cfebf 100644
--- a/nsprpub/configure
+++ b/nsprpub/configure
@@ -4653,7 +4653,7 @@ EOF
             fi
         fi
 
-        OS_DLLFLAGS="-nologo -DLL -SUBSYSTEM:WINDOWS"
+        OS_DLLFLAGS="-nologo -DLL -SUBSYSTEM:WINDOWS,5.02"
         if test "$MSC_VER" -le "1200" -a -z "$MOZ_DEBUG_SYMBOLS"; then
             OS_DLLFLAGS="$OS_DLLFLAGS -PDB:NONE"
         fi
diff --git a/nsprpub/configure.in b/nsprpub/configure.in
index 88c610b..e7c7bde 100644
--- a/nsprpub/configure.in
+++ b/nsprpub/configure.in
@@ -1993,7 +1993,7 @@ tools are selected during the Xcode/Developer Tools installation.])
             fi
         fi
 
-        OS_DLLFLAGS="-nologo -DLL -SUBSYSTEM:WINDOWS,5.01"
+        OS_DLLFLAGS="-nologo -DLL -SUBSYSTEM:WINDOWS,5.02"
         if test "$MSC_VER" -le "1200" -a -z "$MOZ_DEBUG_SYMBOLS"; then
             OS_DLLFLAGS="$OS_DLLFLAGS -PDB:NONE"
         fi
diff --git a/security/nss/coreconf/WIN32.mk b/security/nss/coreconf/WIN32.mk
index a297514..ec4e200 100644
--- a/security/nss/coreconf/WIN32.mk
+++ b/security/nss/coreconf/WIN32.mk
@@ -113,7 +113,7 @@ ifdef NS_USE_GCC
 else # !NS_USE_GCC
     OS_CFLAGS += -W3 -nologo -D_CRT_SECURE_NO_WARNINGS \
 		 -D_CRT_NONSTDC_NO_WARNINGS
-    OS_DLLFLAGS += -nologo -DLL -SUBSYSTEM:WINDOWS,5.01
+    OS_DLLFLAGS += -nologo -DLL -SUBSYSTEM:WINDOWS,5.02
     ifeq ($(_MSC_VER),$(_MSC_VER_6))
     ifndef MOZ_DEBUG_SYMBOLS
 	OS_DLLFLAGS += -PDB:NONE
diff --git a/toolkit/mozapps/installer/windows/nsis/common.nsh b/toolkit/mozapps/installer/windows/nsis/common.nsh
index 6e2b66e..0538725 100644
--- a/toolkit/mozapps/installer/windows/nsis/common.nsh
+++ b/toolkit/mozapps/installer/windows/nsis/common.nsh
@@ -5009,7 +5009,7 @@
 
       !ifdef HAVE_64BIT_OS
         ${Unless} ${RunningX64}
-        ${OrUnless} ${AtLeastWinVista}
+        ${OrUnless} ${AtLeastWinXP}
           MessageBox MB_OK|MB_ICONSTOP "$R9" IDOK
           ; Nothing initialized so no need to call OnEndCommon
           Quit
-- 
1.8.3.msysgit.0

